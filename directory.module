<?php

/*
 * Implements hook_node_info
 */
function directory_node_info() {
  return array(
    'directory_profile' => array(
      'name' => t('Directory Profile'),
      'base' => 'directory_profile',
      'description' => t('Directory Information.'),
      'has_title' => TRUE,
      'locked' => FALSE,
    ),
  );
  return $squawk_update;
}
/*
 * Implements hook_form
 */
function directory_form($node, &$form_state) {
   return node_content_form($node, $form_state);
}
/*
 * Implements hook_form_alter
 */
function directory_form_alter(&$form, &$form_state, $form_id) {
    if ($form_id == 'directory_profile_node_form') {
      drupal_set_message('here in alter');
    }
}

function directory_node_presave($node) {
  if($node->type == 'directory_profile') {
  //The title is <name>'s profile
    if(is_null($node->title)){
      if(!empty($node->field_first_name[LANGUAGE_NONE][0]['value']) &&
        !empty($node->field_last_name[LANGUAGE_NONE][0]['value'])) {
          $node->title = $node->field_first_name[LANGUAGE_NONE][0]['value']
            . ' ' . $node->field_last_name[LANGUAGE_NONE][0]['value']
            . '\'s Profile';
      }
      else {
        $node->title = 'Directory Profile';
      }
    }
  }

}

function create_new_ids($include_ldap = NULL) {
  //find new users or people who don't have taxonomy terms yet.
  $vid = variable_get('directory_ids_vocabulary', 0);
  $tids = array();
  if ($vid>0) {
    $query = 'SELECT u.name FROM {users} u' .
      ' LEFT JOIN {taxonomy_term_data} t ON u.name = t.name' .
      ' WHERE t.name IS NULL AND u.status = 1';
    $result = db_query($query)->fetchAll();
    dsm($result);
    foreach($result as $record) {
      //$record->name is available
      $new_term = array(
        'name' => $record->name,
        'description' => $desc,
        'vid' => $vid,
      );
      $term_obj = (object) $new_term;
      taxonomy_term_save($term_obj);
      $tids[]=$term_obj->tid;
    }
  }
  if($include_ldap) {

  }
  return $tids;
}
/*
 * Query Ldap
 */
function directory_query_ldap($depts = array()) {
    if(count($depts == 0)) {
      $depts[] = '8107';
    }
    $result = array();
    // setup LDAP parameters
    $ldapUrl = "ldaps://eds.arizona.edu";
    $ldapPort = 636;
    $bindDn = "uid=sasg-drupal,ou=App Users,dc=eds,dc=arizona,dc=edu";
    $bindPw = "Jm2GvdiyeSQKB7UL8zeAjmW59Hdz2yAP";
    $searchBase = "ou=People,dc=eds,dc=arizona,dc=edu";
    //$searchFilter = "(uid=bourgeot)";
  $deptStr ='(|';
  foreach($depts as $dept) {
    $deptStr .= '(employeePrimaryDept=' . $dept . ')';
  }
  $deptStr .= ')';

  $parms['filter'] = '(&(employeeStatus=A)(!(uaid=T*))' . $deptStr . ')';
  //$parms['attrs'] = array('uid','cn','sn','mail','givenName','eduPersonPrimaryAffiliation','dateOfBirth','');
  $parms['attrs'] = array(
    'placeholder',
    //'cn',
    'sn',
    'givenName',
    'eduPersonPrimaryAffiliation',
    'uid',
    //'mail',
    'dateOfBirth',
    'employeeBldgNum',
    'employeeBldgName',
    //'employeeIsFerpaTrained',
    //'employeeOfficialOrg',
    'employeePhone',
    'employeePrimaryDept',
    'employeePrimaryTitle',
    //'employeeStatus',
    //'eduPersonAffiliation'
  );// mult

  // establish LDAP connection
  $ldap = ldap_connect($ldapUrl,$ldapPort);
  if (! $ldap) {
    error_log("Could not connect to LDAP server");
  }
  // bind as app user
  if (! ldap_bind($ldap, $bindDn, $bindPw)) {
    error_log(ldap_error($ldap));
  }
  // retrieve entry
  $i=0;
  $sr = ldap_search($ldap, $searchBase, $parms['filter'], $parms['attrs']);
  $e=ldap_get_entries($ldap,$sr);
  $entry = ldap_first_entry($ldap, $sr);
  while ($entry) {
      foreach($parms['attrs'] as $attr) {
        if ($attr != 'placeholder') {
          $vals = ldap_get_values($ldap, $entry, $attr);
        //$attrs = ldap_get_attributes($ldap, $entry);
      //dsm($vals);
      //dsm($attrs);
        //$results[] = $attrs;
      //$i++;
          $result[$i][$attr]=$vals[0];
        }
      }
      $i++;
    $entry = ldap_next_entry($ldap, $entry);
  }

  ldap_close($ldap);
 //dsm($output);
  return $result;
}
function directory_create_profile_nodes() {
  //conjure what departments to create nodes for
  //for each department, fetch the ldap entries
  //create nodes for that department
  $entries = directory_query_ldap();
  dsm($entries);
  foreach ($entries as $entry) {
    $node = directory_create_profile_node($entry);
    dsm($node->title . ' created.');
  }
}
function directory_create_profile_node($p) {
  //creates a profile node for $p.
/*
0 (Array, 9 elements)
    sn (String, 8 characters ) Rallison
    givenName (String, 17 characters ) Gabriel Kartchner
    eduPersonPrimaryAffiliation (String, 7 characters ) student
    uid (String, 8 characters ) rallison
    dateOfBirth (String, 8 characters ) 19901219
    employeeBldgNum (String, 4 characters ) 409A
    employeeBldgName (String, 28 characters ) Enrollment Mngmt Systems Grp
    employeePhone (String, 10 characters ) 5206260755
    employeePrimaryTitle (String, 15 characters ) Student Group B

        $node_copy = new stdClass();
        $node_copy = clone $node;
        $node_copy->nid = NULL;
        $node_copy->vid = NULL;
        $node_copy->tnid = NULL;
        $node_copy->created = NULL;
        $node_copy->path = NULL;
        $node_copy->field_recipient[LANGUAGE_NONE][0]['value'] = $recipient;
        node_save($node_copy);
        $success = $node_copy->nid;
        if ($success > 0) {
          drupal_set_message($node->nid, 'status');

*/
  //make sure $p is an array
  //setup a new node
  $node = new stdClass();
  $node->type = 'directory_profile';
  $node->language = LANGUAGE_NONE;
  $node->nid = NULL;
  $node_copy->vid = NULL;
  $node_copy->tnid = NULL;
  $node_copy->created = NULL;
  $node_copy->path = NULL;
  $node->uid = 1; //created by user 1 initially
  $node->log = 'created programmatically';
  $node->status = 1;
  $node->comment = 0;
  $node->promote = 0;
  $node->sticky = 0;
  $node->title = '';
  node_save($node);
  if($node->nid != NULL) {
    //node_load($node);
    //dsm($node);
    if(!empty($p['givenName']) && !empty($p['sn'])) {
      $node->title = $p['givenName'] . ' ' . $p['sn'] . '\'s Profile';
    }
    else {
      $node->title = $p['uid'] . '\'s Profile';
    }
    //set up text fields
    $node->field_first_name[LANGUAGE_NONE][0]['value'] = $p['givenName'];
     $node->field_last_name[LANGUAGE_NONE][0]['value'] = $p['sn'];

    $node->field_primary_title[LANGUAGE_NONE][0]['value'] = $p['employeePrimaryTitle'];

    $node->field_primary_phone[LANGUAGE_NONE][0]['value'] = $p['employeePhone'];


    //set up for fetching terms from the varaious vocabularies.
    //find the location or add it if it hasn't been encountered yet
    //$vid = variable_get('ua_locations_vocabulary');

    $term_array = taxonomy_get_term_by_name($p['employeeBldgName'], 'ua_locations');
    dsm($term_array);
    if (empty($term_array)) {
      //add it
      $term_obj= directory_create_term('ua_locations', $p['employeeBldgName'], $p['employeeBldgNum']);
    }
    else {
      $term_obj = array_shift($term_array);
    }
    //
    $node->field_ua_locations[LANGUAGE_NONE][0]['tid'] = $term_obj->tid;
    //letter
    $term_array = taxonomy_get_term_by_name($p['sn'][0], 'alphabet');
    $term_obj = array_shift($term_array);
    $node->field_alphabet[LANGUAGE_NONE][0]['tid'] = $term_obj->tid;
    //dept
    $vid = variable_get('ua_orgs_vocabulary');
    $term_array = taxonomy_get_term_by_name($p['employeePrimaryDept'], 'ua_orgs');
    $term_obj = array_shift($term_array);
    //$node->field_department[LANGUAGE_NONE][0]['tid'] = $term_obj->tid;
    //affiliation
    $vid = variable_get('ua_affiliations_vocabulary');
    $term_array = taxonomy_get_term_by_name($p['eduPersonPrimaryAffiliation'], 'ua_affiliations');
    $term_obj = array_shift($term_array);
    $node->field_ua_affiliations[LANGUAGE_NONE][0]['tid'] = $term_obj->tid;
  }
  node_save($node);
  if($node->nid != NULL) {
    return $node;
  }
  else {
    return FALSE;
  }
}
function get_query_depts($dept='VP for Student Affairs') {
  $terms=array();
  $vid = variable_get('ua_orgs_vocabulary',0);
  $base_terms = taxonomy_get_term_by_name($dept, 'ua_orgs');
  if(!empty($base_terms)) {
    //should be one entry
    dsm($base_terms);
    foreach($base_terms as $tid=>$base) {
      $terms = directory_taxonomy_get_children_all($tid, $vid);
    }
    //append the base term to the set
    //$terms[] = $term;
  }
  return $terms;
}
function directory_taxonomy_get_children_all($tid, $vid = 0, $key = 'tid'){
$c = taxonomy_get_children($tid, $vid, $key);
$result = array();
foreach ($c as $t => $d){
$result[$t] = $d;
$below = directory_taxonomy_get_children_all($t, $vid, $key);
if (!empty($below)) {
foreach ($below as $nt => $nd){
$result[$nt] = $nd;
}
}
}
return $result;
}
/*
 * Implements hook_menu()
 */
function directory_menu() {
 $items = array(

 );
 return $items;
}
/**
 * Create a single term and add to a specific vocabulary if not already present
 *  @vocab - the machine name of the vocabulary
 *  @term - the human readable name of the term to be added
 *
 *  @desc - the humna readable description of the term to be added (Optional)
 *  @weight - the weight of the term in the vocabulary list (Optional)
 */
function directory_create_term($vocab_name, $term, $desc = '', $weight = 0, $add_parent = 0)  {
  $added = NULL;
  $added = taxonomy_get_term_by_name($term);
  $vid = variable_get($vocab_name . '_vocabulary', 0);
  if ($added == '' || $added == NULL || $vid > 0)  {
    $new_term = array(
      'name' => $term,
      'description' => $desc,
      'parent' => array($add_parent),
      'weight' => $weight,
      'vid' => $vid,
    );
    $term_obj = (object) $new_term;
    taxonomy_term_save($term_obj);
    //in case you want it.
    if ($term_obj->tid > 0) {
      return $term_obj;
    }
    else { return 'trouble'; }
  }
}
